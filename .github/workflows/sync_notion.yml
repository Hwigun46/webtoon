name: Sync GitHub Issues to Notion (Spring)

on:
  issues:
    types: [opened, closed]
  pull_request:
    types: [opened, closed]

jobs:
  update_issue_status:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Determine Notion Status Update
        id: determine_status
        run: |
          if [[ "${{ github.event_name }}" == "issues" && "${{ github.event.action }}" == "opened" ]]; then
            echo "STATUS=ì‘ì—… ì¤‘" >> $GITHUB_ENV
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "opened" ]]; then
            echo "STATUS=ë¦¬ë·° ëŒ€ê¸°" >> $GITHUB_ENV
          elif [[ ("${{ github.event_name }}" == "issues" && "${{ github.event.action }}" == "closed") || ("${{ github.event_name }}" == "pull_request" && "${{ github.event.action }}" == "closed") ]]; then
            echo "STATUS=ì™„ë£Œ" >> $GITHUB_ENV
          else
            echo "âŒ í•´ë‹¹ ì´ë²¤íŠ¸ëŠ” ì²˜ë¦¬í•  í•„ìš” ì—†ìŒ."
            exit 0
          fi

      - name: Extract Issue Number for PRs
        if: github.event_name == 'pull_request'
        run: |
          PR_ISSUE_URL="${{ github.event.pull_request.issue_url }}"
          ISSUE_NUMBER=$(basename "$PR_ISSUE_URL")

          if [[ -z "$ISSUE_NUMBER" || "$ISSUE_NUMBER" == "null" ]]; then
            echo "âŒ PRì— ì—°ê²°ëœ Issueê°€ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          else
            echo "ğŸ” PR ì—°ê²°ëœ Issue ë²ˆí˜¸: $ISSUE_NUMBER"
            echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV
          fi

      - name: Set Issue Number for Issue Events
        if: github.event_name == 'issues'
        run: |
          echo "ISSUE_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV

      - name: Find Notion Page for the Issue
        run: |
          echo "ğŸ” Searching for Notion Page with Issue Number: $ISSUE_NUMBER"

          QUERY_RESULT=$(curl -X POST "https://api.notion.com/v1/databases/${{ secrets.NOTION_DATABASE_ID }}/query" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data '{
            "filter": {
              "property": "ì´ìŠˆ ë²ˆí˜¸",
              "number": {
                "equals": '"$ISSUE_NUMBER"'
              }
            }
          }')

          page_id=$(echo "$QUERY_RESULT" | jq -r '.results[0].id')

          if [[ "$page_id" != "null" && "$page_id" != "" ]]; then
            echo "âœ… Notion Page ID ì°¾ìŒ: $page_id"
            echo "PAGE_ID=$page_id" >> $GITHUB_ENV
          else
            echo "âŒ Notion í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

      - name: Update Notion Page Status
        run: |
          curl -X PATCH "https://api.notion.com/v1/pages/${{ env.PAGE_ID }}" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data '{
            "properties": {
              "ìƒíƒœ": { "status": { "name": "'"${{ env.STATUS }}"'" } }
            }
          }'

          echo "âœ… Notion ìƒíƒœê°€ '${{ env.STATUS }}'ë¡œ ì—…ë°ì´íŠ¸ë¨."