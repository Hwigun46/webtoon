name: Sync GitHub Issues to Notion (Spring)

on:
  issues:
    types: [opened, closed]  # ğŸ¯ "opened" (ì´ìŠˆ ìƒì„±) + "closed" (ì´ìŠˆ ë‹«í˜) í•¨ê»˜ ì²˜ë¦¬

jobs:
  sync_issue:
    if: github.event.action == 'opened'  # ğŸ¯ ì´ìŠˆ ìƒì„± ì²˜ë¦¬
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js (í•„ìˆ˜)
        uses: actions/setup-node@v4  # ìµœì‹  ë²„ì „ ì ìš©

      - name: Convert Issue Body to JSON (ê°œí–‰ ë° íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬)
        run: |
          echo '${{ github.event.issue.body }}' | jq -Rs '.' > issue_body.json

      - name: Send Issue to Notion
        run: |
          ISSUE_BODY=$(cat issue_body.json)

          response=$(jq -n \
          --arg database_id "${{ secrets.NOTION_DATABASE_ID }}" \
          --arg title "${{ github.event.issue.title }}" \
          --arg url "${{ github.event.issue.html_url }}" \
          --arg status "ì‘ì—… ì¤‘" \
          --arg team "SPRING" \
          --arg assignee "${{ github.event.issue.user.login }}" \
          --arg issue_body "$ISSUE_BODY" \
          '{
            parent: { database_id: $database_id },
            properties: {
              "ì œëª©": { title: [{ text: { content: $title } }] },
              "URL": { url: $url },
              "ìƒíƒœ": { status: { name: $status } },
              "íŒ€": { select: { name: $team } },
              "ë‹´ë‹¹ì": { rich_text: [{ type: "text", text: { content: $assignee } }] }
            },
            children: [
              {
                object: "block",
                type: "paragraph",
                paragraph: {
                  rich_text: [
                    { type: "text", text: { content: ($issue_body | gsub("\""; "\\\"") | gsub("\n"; "\\n")) } }
                  ]
                }
              }
            ]
          }' | tee notion_response.json | curl -X POST "https://api.notion.com/v1/pages" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data @-)

          echo "Notion API Response: $response"

          # ğŸ¯ Notionì—ì„œ ìƒì„±ëœ page_idë¥¼ ê°€ì ¸ì™€ì„œ íŒŒì¼ë¡œ ì €ì¥
          page_id=$(echo "$response" | jq -r '.id')

          if [[ "$page_id" != "null" && "$page_id" != "" ]]; then
            echo "$page_id" > notion_page_id.txt
            echo "âœ… Notion Page ID ì €ì¥ ì™„ë£Œ: $page_id"
          else
            echo "âŒ Notion Page IDê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. API ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”."
            cat notion_response.json
            exit 1
          fi

      - name: Check & Upload Notion Page ID
        run: |
          if [ -f notion_page_id.txt ]; then
            echo "âœ… Notion Page ID íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ì—…ë¡œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
          else
            echo "âŒ Notion Page ID íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì—…ë¡œë“œë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
            exit 1
          fi
        continue-on-error: false

      - name: Upload Notion Page ID
        uses: actions/upload-artifact@v4
        with:
          name: notion_page_id
          path: notion_page_id.txt

  update_issue:
    if: github.event.action == 'closed'  # ğŸ¯ ì´ìŠˆ ë‹«í˜ ì²˜ë¦¬
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js (í•„ìˆ˜)
        uses: actions/setup-node@v4  # ìµœì‹  ë²„ì „ ì ìš©

      - name: Download Notion Page ID
        uses: actions/download-artifact@v4
        with:
          name: notion_page_id
        continue-on-error: true

      - name: Check if Notion Page ID Exists
        run: |
          ls -l
          if [ ! -f notion_page_id.txt ]; then
            echo "âŒ Notion Page ID íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Artifactê°€ ì •ìƒì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          else
            echo "âœ… Notion Page ID íŒŒì¼ì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤."
          fi

      - name: Read Notion Page ID
        run: |
          page_id=$(cat notion_page_id.txt)
          echo "Updating Notion Page ID: $page_id"
          
          curl -X PATCH "https://api.notion.com/v1/pages/$page_id" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data '{
            "properties": {
              "ìƒíƒœ": { "status": { "name": "ì™„ë£Œ" } }
            }
          }'