name: Sync GitHub Issues to Notion (Spring)

on:
  issues:
    types: [opened, closed]  # ğŸ¯ "opened" (ì´ìŠˆ ìƒì„±) + "closed" (ì´ìŠˆ ë‹«í˜) í•¨ê»˜ ì²˜ë¦¬

jobs:
  sync_issue:
    if: github.event.action == 'opened'  # ğŸ¯ ì´ìŠˆ ìƒì„± ì²˜ë¦¬
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js (í•„ìˆ˜)
        uses: actions/setup-node@v4  # ìµœì‹  ë²„ì „ ì ìš©

      - name: Send Issue to Notion
        run: |
          # GitHub Issue ë³¸ë¬¸ì„ JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          GITHUB_ISSUE_BODY_JSON=$(jq -Rs . <<< "${{ github.event.issue.body }}")

          response=$(curl -X POST "https://api.notion.com/v1/pages" \
          -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
          -H "Content-Type: application/json" \
          -H "Notion-Version: 2022-06-28" \
          --data @<(cat <<EOF
          {
            "parent": { "database_id": "${{ secrets.NOTION_DATABASE_ID }}" },
            "properties": {
              "ì œëª©": { "title": [{ "text": { "content": "${{ github.event.issue.title }}" } }] },
              "URL": { "url": "${{ github.event.issue.html_url }}" },
              "ìƒíƒœ": { "status": { "name": "ì‘ì—… ì¤‘" } },
              "íŒ€": { "select": { "name": "SPRING" } },
              "ë‹´ë‹¹ì": { "rich_text": [{ "type": "text", "text": { "content": "${{ github.event.issue.user.login }}" } }] }
            },
            "children": [
              {
                "object": "block",
                "type": "paragraph",
                "paragraph": {
                  "rich_text": [
                    { "type": "text", "text": { "content": $GITHUB_ISSUE_BODY_JSON } }
                  ]
                }
              }
            ]
          }
  EOF
  ))

echo "Notion API Response: $response"

# ğŸ¯ Notionì—ì„œ ìƒì„±ëœ page_idë¥¼ ê°€ì ¸ì™€ì„œ íŒŒì¼ë¡œ ì €ì¥
  page_id=$(echo "$response" | jq -r '.id')
  echo "$page_id" > notion_page_id.txt

- name: Upload Notion Page ID
  uses: actions/upload-artifact@v4  # ğŸ”¹ ìµœì‹  ë²„ì „ ì ìš©
  with:
    name: notion_page_id
    path: notion_page_id.txt

update_issue:
  if: github.event.action == 'closed'  # ğŸ¯ ì´ìŠˆ ë‹«í˜ ì²˜ë¦¬
  runs-on: ubuntu-latest
  steps:
    - name: Setup Node.js (í•„ìˆ˜)
      uses: actions/setup-node@v4  # ìµœì‹  ë²„ì „ ì ìš©

    - name: Download Notion Page ID
      uses: actions/download-artifact@v4  # ğŸ”¹ ìµœì‹  ë²„ì „ ì ìš©
      with:
        name: notion_page_id

    - name: Read Notion Page ID
      run: |
        page_id=$(cat notion_page_id.txt)
        echo "Updating Notion Page ID: $page_id"
        
        curl -X PATCH "https://api.notion.com/v1/pages/$page_id" \
        -H "Authorization: Bearer ${{ secrets.NOTION_API_KEY }}" \
        -H "Content-Type: application/json" \
        -H "Notion-Version: 2022-06-28" \
        --data '{
          "properties": {
            "ìƒíƒœ": { "status": { "name": "ì™„ë£Œ" } }
          }
        }'